.\"
.\" $Id: milter-greylist.8,v 1.32 2005/01/29 18:24:17 manu Exp $
.\"
.\" Copyright (c) 2004 Emmanuel Dreyfus
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"        This product includes software developed by Emmanuel Dreyfus
.\"
.\" THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED
.\" WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
.\" OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
.\" DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
.\" INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
.\" (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
.\" SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
.\" STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
.\" ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
.\" OF THE POSSIBILITY OF SUCH DAMAGE.
.\"

.Dd Feb 21, 2004
.Dt milter-greylist 8
.Os
.Sh NAME
.Nm milter-greylist
.Nd grey listing filter for sendmail
.Sh SYNOPSIS
.Nm
.Op Fl A
.Op Fl a Ar delay
.Op Fl c
.Op Fl D
.Op Fl d Ar dumpfile
.Op Fl f Ar configfile
.Op Fl l
.Op Fl q
.Op Fl r
.Op Fl S
.Op Fl T
.Op Fl u Ar username
.Op Fl v
.Op Fl w Ar delay
.Op Fl L Ar cidrmask
.Op Fl M Ar prefixlen
.Op Fl P Ar pidfile
.Fl p Ar socket
.Sh DESCRIPTION
.Nm 
is a mail filter for sendmail that implements grey listing,
a spam filtering technique proposed by Evan Harris.
.Pp
Grey listing works by assuming that contrarily to legitimate MTA, spam engines
will not retry sending their junk mail on a temporary error. The filter
will always temporarily reject mail on a first attempt, and 
accept it after some time has elapsed.
.Pp
If spammers ever try to resend rejected messages, we can assume they will 
not stay idle between the two sends. Odds are good that the spammer will 
send a mail to an honey pot address and get blacklisted in a distributed 
black list before the second attempt.
.Pp
Of course, the filter can be configured to not apply grey listing to some
hosts or networks. You can whitelist friendly SMTP servers, and you should
whitelist your own network, otherwise your SMTP clients will have real trouble to 
send e-mail. Whitelisting localhost is also a must.
.Pp
.Nm
works with two files. 
.Pa greylist.conf
is the configuration file. It holds the whitelist of addresses that will 
not suffer grey list filtering.  It is read once upon 
.Nm
startup, then it will be automatically reloaded whenever a new message
gets in and if it had been modified. You should not send
.Nm
a 
.Li kill -1
as it will just terminate it (libmilter works that way).
.Pp
See 
.Xr greylist.conf 5
for documentation on the file's format.
.Pp
The second file is
.Pa greylist.db .
.Nm
will regularly dump its grey list database into this file, which is used
on startup to restore the previous grey list state. If the file does not
exist or is unreadable, 
.Nm
will start with an empty grey list. 
.Pp
The default location for the grey list database and the socket for
communicating with sendmail is normally /var/milter-greylist.
That directory must be owned and writeable by the user id under
which 
.Nm
will run.
.Pp
The following options are available;
if present, they override their equivalents specified in the configuration file:
.Bl -tag -width flag
.It Fl A
Normally, 
.Nm
does not greylist senders that succeeded SMTP AUTH. This option disables that
feature and causes authentication to be ignored.
Equivalent to the
"noauth"
option in the configuration file.
.It Fl a Ar delay
Configure auto-whitelisting. After a tuple (sender IP, sender e-mail, 
recipient e-mail) has been accepted, other identical tuples will get
accepted for 
.Ar delay .
The default is one day. Use zero to disable auto-whitelisting.
A suffix can be added to specify seconds (s), minutes (m), hours (h), 
days (d) or weeks (w). Whithout any suffix, values are treated as seconds.
Equivalent to the
"autowhite"
option in the configuration file.
.It Fl c
Only check the configuration file and exit. Return value is 0 if the
configuration is valid, or an error code from 
.Aq Pa sysexit.h
otherwise.
.It Fl D
Do not fork; run in the foreground instead. Without this flag, 
.Nm
will become a daemon.
Equivalent to the
"nodetach"
option in the configuration file.
.It Fl d Ar dumpfile
Location of the dump file. Default is 
.Pa /var/milter-greylist/greylist.db
Equivalent to the
"dumpfile"
option in the configuration file.
.It Fl f Ar configfile
Location of the config file. Default is
.Pa /etc/mail/greylist.conf .
.It Fl L Ar cidrmask
Use 
.Ar cidrmask
as a matching mask when checking IPv4 addresses entries in the greylist. This
is aimed as a workaround to mail farms that re-emit messages from different
IP addresses. With -L 24,
the matching mask is 255.255.255.0, and all addresses within the same class C
network are considered the same. Default is -L 32, 
which corresponds to all addresses considered different.
.It Fl L Ar prefixlen
Use 
.Ar prefixlen
as a matching mask when checking IPv6 addresses entries in the greylist. This
is aimed as a workaround to mail farms that re-emit messages from different
IP addresses. With -M 64,
the matching mask is ffff:ffff:ffff:ffff::, and all addresses within the same
subnet are considered the same. Default is -M 128,
which corresponds to all IPv6 addresses considered different.
.It Fl l
Enable debug output in the access-list management code.
.It Fl P Ar pidfile
write the daemon's PID to 
.Ar pidfile .
Equivalent to the
"pidfile"
option in the configuration file.
.It Fl p Ar socket
Use 
.Ar socket
as the socket used by 
.Xr sendmail 8
to communicate with
.Nm .
.It Fl q
Quiet mode. 
.Nm
will not tell SMTP clients how much time they have to wait before the
message will be accepted.
Equivalent to the
"quiet"
option in the configuration file.
.It Fl r
Display 
.Nm
version and build environnement, then exit.
.It Fl S
If
.Nm
was built with SPF support, then SPF-compliant senders bypass greylisting.
This flag causes messages to be greylisted regardless of whether they are 
SPF-compliant or not.
Equivalent to the
"nospf"
option in the configuration file.
.It Fl T
Enable test mode. This alters the meaning of 
.Ar rcpt
lines in 
.Pa greylist.conf ,
so that only messages sent to recipient adresses listed there are 
selected for greylisting. This option and the 
.Ar rcpt
lines have been deprecated in favor of ACL, so do not use it. 
.It Fl u Ar username
Drop root privileges and switch to 
.Ar username
credentials.  Make sure this user has write access to 
.Pa greylist.db .
Equivalent to the
"user"
option in the configuration file.
.It Fl v
Enable debug output. 
.Nm 
will send messages (and debug output if it is given the
.Fl v
flag) to 
.Xr syslogd 8
with facility LOG_MAIL.
Equivalent to the
"verbose"
option in the configuration file.
.It Fl w Ar delay
sets the minimum delay between the first attempt and the time
the message can be accepted. Default is 30 minutes. 
A suffix can be added to specify seconds (s), minutes (m), hours (h), 
days (d) or weeks (w). Whithout any suffix, values are treated as seconds.
Equivalent to the
"greylist"
option in the configuration file.
.El
.Sh GREYLIST MX SYNC
.Nm
is now able to sync the greylist between multiple MX. In order to enable
this feature, you need to list the peer MX's in 
.Pa greylist.conf ,
just like this:
.Dl peer 192.0.2.17
.Dl peer 192.0.2.18
.Pp
When peers are configured, 
.Nm
will listen on port defined for the mxglsync service in
.Pa /etc/services 
(defaults to 5252), and it will connect to peers at this port. Each time 
an entry will be added or deleted on one MX, it will be propagated to 
the others. 
.Pp
The protocol is quite simple, just
telnet to your MX at port 5252, and type help to see how it works. Note that
connections will only be accepted from peer MX's, even localhost will be
rejected (and don't ever add localhost as a peer for MX sync, as you will 
cause each entry in the greylist to be added twice).
.Pp
If an MX is down, changes to the greylist will be queued until it gets
back up again. The queue length is limited (default is 1024 entries), and
if it overflows, newer entries will be discarded.
.Sh AUTHORS
.An Emmanuel Dreyfus Aq manu@netbsd.org
.Pp 
.Nm
received many contributions from (in alphabetic order):
.An Gary Aitkeno ,  
.An Joel Bertrand ,
.An Moritz Both ,
.An Attila Bruncsak ,
.An Remy Card ,
.An Alexandre Cherif , 
.An Eugene Crosser ,
.An Cyril Guibourg ,
.An Klas Heggemann ,
.An Mattieu Herrb ,
.An Dan Hollis ,
.An Per Holm ,
.An Stephane Lentz ,
.An Ivan F. Martinez ,
.An Christian Pelissier ,
.An Matthias Scheler , 
.An Wolfgang Solfrank , 
.An Hajimu Umemoto ,
and
.An Lev Walkin .
.Pp
Thanks to 
.An Helmut Messerer
and
.An Thomas Pfau
for their feebacks on the first releases of this software.
.Sh SEE ALSO
.Xr greylist.conf 5 ,
.Xr sendmail 8 , 
.Xr syslogd 8 .
.Pp
Evan Harris's paper
.Pa http://projects.puremagic.com/greylisting
